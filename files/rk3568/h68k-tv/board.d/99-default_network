#!/bin/sh
# h68k-tv 网络接口配置

. /lib/functions/uci-defaults.sh

# 如果已经配置过网络，退出
json_is_a network object && exit 0

# 简单的MAC地址生成（基于eth0的永久地址）
generate_mac() {
    local base_mac=$(cat /sys/class/net/eth0/address 2>/dev/null)
    if [ -z "$base_mac" ]; then
        # 如果没有获取到，使用固定的OUI（Organizationally Unique Identifier）
        echo "00:18:82:$(hexdump -n3 -e '/1 ":%02X"' /dev/random | cut -c2-)"
    else
        # 基于eth0的MAC地址递增
        local last_byte=$(echo $base_mac | awk -F: '{printf "%02X", strtonum("0x"$6)+1}')
        echo "$(echo $base_mac | cut -d: -f1-5):$last_byte"
    fi
}

# 获取MAC地址
LAN_MAC=$(generate_mac)
WAN_MAC=$(macaddr_add $LAN_MAC +1)

# 设置接口
ucidef_set_interfaces_lan_wan 'eth1' 'eth0'
ucidef_set_interface_macaddr "lan" $LAN_MAC
ucidef_set_interface_macaddr "wan" $WAN_MAC

board_config_flush

exit 0
